<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">

<head>
<title>Ruby on Rails 101</title>
<!-- metadata -->
<meta name="generator" content="S5" />
<meta name="version" content="S5 1.1" />
<meta name="presdate" content="&date" />
<meta name="author" content="Peter Marklund" />
<meta name="organization" content="&organization;" />
<meta name="company" content="Rails Mentor" />
<!-- configuration parameters -->
<meta name="defaultView" content="slideshow" />
<meta name="controlVis" content="hidden" />
<!-- style sheet links -->
<link rel="stylesheet" href="../ui/default/slides.css" type="text/css" media="projection" id="slideProj" />
<link rel="stylesheet" href="../ui/default/outline.css" type="text/css" media="screen" id="outlineStyle" />
<link rel="stylesheet" href="../lib/stylesheets/print.css" type="text/css" media="print" id="slidePrint" />
<link rel="stylesheet" href="../ui/default/opera.css" type="text/css" media="projection" id="operaFix" />

<link rel="stylesheet" href="../lib/stylesheets/pressie.css" type="text/css" />

<!-- S5 JS -->
<script src="../ui/default/slides.js" type="text/javascript"></script>

<!-- Syntax Highlighter -->
<link rel="stylesheet"  href="../dp.SyntaxHighlighter/Styles/SyntaxHighlighter.css"></link>

</head>
<body>

<div class="layout">
<div id="controls"><!-- DO NOT EDIT --></div>
<div id="currentSlide"><!-- DO NOT EDIT --></div>
<div id="header"></div>
<div id="footer">
<h2>Copyright &copy; 2009 Peter Marklund</h2>
</div>

</div>


<div class="presentation">
<div class="slide">

	<h1><span class="caps">AJAX</span></h1>


</div>
<div class="slide">

	<h1>Introduction</h1>


	<ul>
	<li><span class="caps">AJAX</span> stands for Asynchronous JavaScript and <span class="caps">XML</span></li>
		<li><span class="caps">AJAX</span> uses an XMLHttpRequest object that does <span class="caps">HTTP</span> requests in the background. This avoids full page reloads and instead update parts of the page. This makes the application more responsive and interactive.</li>
		<li>Rails ships with two <span class="caps">AJAX</span> JavaScript libraries: Prototype and Scriptaculous. Prototype makes remote requests and interacts with the <span class="caps">DOM</span>. Scriptaculous uses Prototype to generate visual effects, auto completion, drag-and-drop etc.</li>
	</ul>


</div>
<div class="slide">

	<h1><span class="caps">AJAX</span> Use Cases</h1>


	<ul>
	<li>Post something in the background and add it to a list on the page</li>
		<li>In-Place form editing</li>
		<li>Autocompletion of a text field</li>
		<li>Drag-and-drop sortable lists</li>
		<li>Live searching</li>
	</ul>


</div>
<div class="slide">

	<h1><span class="caps">AJAX</span> Links</h1>


<div class="code-normal">

<pre name="code" class="ruby:nogutter:nocontrols">

link_to_remote("Destroy", :url =&gt; {:action =&gt; 'destroy', :id =&gt; item},
:confirm =&gt; "Are you sure?" 

link_to_function "Cancel", "$('create_form').hide();" 

link_to_function "Cancel" do |page|
  page[object.dom_id("rate_link")].show
  page[object.dom_id("rate")].hide
end
</pre></div>

</div>
<div class="slide">

	<h1><span class="caps">AJAX</span> Form</h1>


<div class="code-normal">

<pre name="code" class="ruby:nogutter:nocontrols">

&lt;% form_remote_tag :url =&gt; {:action =&gt; 'update'} do %&gt;
  &lt;%= hidden_field_tag "prompt[id]", @prompt.id %&gt;
  &lt;%= render :partial =&gt; 'form', :locals =&gt; {:mode =&gt; 'edit'} %&gt;
  &lt;%= submit_tag "Edit" %&gt;
&lt;% end %&gt;
</pre></div>

</div>
<div class="slide">

	<h1><span class="caps">RJS</span></h1>


	<ul>
	<li><span class="caps">RJS</span> is a Rails Ruby <span class="caps">API</span> for generating JavaScript code that is sent back to the browser and executed there.</li>
		<li><span class="caps">RJS</span> can be used inline in the action by passing the :update argument to the render command. Alternatively you can use an <span class="caps">RJS</span> template file with the ending .rjs for your action.</li>
		<li><span class="caps">RJS</span> is especially useful when you need to update several parts of the page.</li>
	</ul>


</div>
<div class="slide">

	<h1>Example: Posting a Comment &#8211; The View</h1>


<div class="code-normal">

<pre name="code" class="ruby:nogutter:nocontrols">

# In your .rhtml view:
&lt;% form_remote_tag
  :url =&gt; {:controller =&gt; "comments", :action =&gt; "create", :id =&gt; user},
  :html =&gt; { :id =&gt; "comment_form"},
  :before =&gt; "$('spinner').show()",
  :complete =&gt; "$('spinner').hide()" do %&gt;
  &lt;%= text_area "comment", "body", :cols =&gt; 80 %&gt;&lt;br/&gt;
  &lt;%= submit_tag 'Submit' %&gt;
&lt;% end %&gt;

# The form tag generated by form_remote_tag:
&lt;form action="/comments/create/1" id="comment_form" method="post" 
  onsubmit="$('spinner').show(); new Ajax.Request(..."&gt;
</pre></div>

</div>
<div class="slide">

	<h1>Example: Posting a Comment &#8211; The Controller</h1>


<div class="code-normal">

<pre name="code" class="ruby:nogutter:nocontrols">

def create
  @comment = Comment.new(params[:comment])
  if @comment.save
    render :update do |page|
      page.insert_html :bottom, 'comment_list', :partial =&gt; 'comment'
      page.visual_effect :highlight, @comment.dom_id
      page['comment_form'].reset
    end
  else
    render :update do |page|
      page.alert @comment.errors.full_messages.join("\n")
    end
  end
end
</pre></div>

</div>
<div class="slide">

	<h1>Example: Deleting a Comment</h1>


<div class="code-normal">

<pre name="code" class="ruby:nogutter:nocontrols">

# In your .html.erb view:
&lt;%= link_to_remote "Delete", :url =&gt; {:action =&gt; 'destroy', :id =&gt; comment},
  :confirm =&gt; "Are you sure you want to delete your comment?",
  :update =&gt; comment.dom_id %&gt;
&lt;/div&gt;
# In the controller
def destroy
  @comment = Comment.find(params[:id])
  assert_authorized
  @comment.destroy
  render :text =&gt; ''
end
</pre></div>

</div>
<div class="slide">

	<h1>Options for Remote Forms and Links</h1>


<div class="code-normal">

<pre name="code" class="ruby:nogutter:nocontrols">

# Callbacks:
:before # before request is initiated and before request object is created
:after # request object's open method has not been called yet
:loading # request has not been sent yet
:loaded # request has been initiated
:interactive # response is being received
:success # response is ready and in 200 range
:failure # response is ready and is not in 200 range
:complete # response is ready
# Other options
:submit # id of a form to submit, can also be just a div with form elements
:confirm # JavaScript confirm dialog before request
:condition # JavaScript expression that must be true for request to happen
</pre></div>

</div>
<div class="slide">

	<h1>Server Responses to <span class="caps">AJAX</span> Requests</h1>


	<ul>
	<li>Nothing, just <span class="caps">HTTP</span> headers</li>
		<li>An <span class="caps">HTML</span> snippet to be injected into the page</li>
		<li>Structured data (JSON, <span class="caps">XML</span>, YAML, <span class="caps">CSV</span> etc.) to be processed with JavaScript</li>
		<li>JavaScript code to be executed by the browser. Typically generated with <span class="caps">RJS</span>.</li>
	</ul>


</div>
<div class="slide">

	<h1>Options for Updating the Page</h1>


	<ul>
	<li>If the action returns <span class="caps">HTML</span> you can use the :update options which takes a <span class="caps">DOM</span> id where the <span class="caps">HTML</span> should be inserted. You can specify different <span class="caps">DOM</span> ids for success and failure: :update =&gt; {:success =&gt; &#8216;list&#8217;, :failure =&gt; &#8216;error&#8217;}</li>
		<li>In conjunction with the :update options you can specify the :position option which says where the <span class="caps">HTML</span> should be inserted. Possible values are: :before, :top, :bottom, :after</li>
	</ul>


</div>
<div class="slide">

	<h1>Prototype Basics</h1>


<div class="code-normal">

<pre name="code" class="ruby:nogutter:nocontrols">

$A(document.getElementsByTagName('a')).first()
$H({'ren':'happy', 'stimpy':'joy'}).keys()
$('some_id').hide()|show() # instead of document.getElementById('some_id')
$F('login') # The value of field input login
$$('div#footer').invoke('hide') # CSS selector
$$('a').each( function(element) { element.hide() })
</pre></div>

</div>
<div class="slide">

	<h1>Example: An <span class="caps">AJAX</span> Shopping Cart</h1>


<div class="code-normal">

<pre name="code" class="ruby:nogutter:nocontrols">

# In index.rhtml:
&lt;% form_remote_tag :url =&gt; { :action =&gt; :add_to_cart, :id =&gt; product } do %&gt;
&lt;%= submit_tag "Add to Cart" %&gt;
&lt;% end %&gt;

# The action:
def add_to_cart
  product = Product.find(params[:id])  
  @current_item = @cart.add_product(product)
  redirect_to_index unless request.xhr?
end
</pre></div>

</div>
<div class="slide">

	<h1>Example: Shopping Cart <span class="caps">RJS</span> Template</h1>


<div class="code-normal">

<pre name="code" class="ruby:nogutter:nocontrols">

# The RJS template add_to_cart.js.rjs:
page.select("div#notice").each { |div| div.hide }
page.replace_html("cart", :partial =&gt; "cart", :object =&gt; @cart)
page[:cart].visual_effect :blind_down if @cart.total_items == 1                 
page[:current_item].visual_effect :highlight, :startcolor =&gt; "#88ff88", :endcolor =&gt; "#114411" 
</pre></div>

</div>
<div class="slide">

	<h1><span class="caps">RJS</span> Methods</h1>


<div class="code-normal">

<pre name="code" class="ruby:nogutter:nocontrols">

# Position argument is one of :before, :top, :bottom, :after
page.insert_html :bottom 'todo_list', "&lt;li&gt;#{todo.name}&lt;/li&gt;" 
page.replace_html 'flash_notice', "Todo added: #{todo_name}" 
page.replace 'flash_notice', :partial =&gt; 'flash', :object =&gt; todo
page[:flash_notice].remove|show|hide|toggle # page[:flash_notice] &lt;=&gt; $('flash_notice') 
page.alert "The form contains the following errors: #{errors.join(“, “)}" 
page.redirect_to :controller =&gt; 'blog', :action =&gt; 'list'
</pre></div>

</div>
<div class="slide">

	<h1>More <span class="caps">RJS</span> Methods</h1>


<div class="code-normal">

<pre name="code" class="ruby:nogutter:nocontrols">

# Available effects: :fade, :appear, :blind_up/down,
# :slide_up/down, :highlight, :shake, :pulsate, etc.
page.visual_effect :pulsate, 'flash_notice'
page.delay(3) do
  page.visual_effect :fade, 'flash_notice'
end
page.select('p.welcome b').first.hide
page.select('#items li').each do |value|
  value.hide
end
</pre></div>

</div>
<div class="slide">

	<h1>Observing Forms</h1>


<div class="code-normal">

<pre name="code" class="ruby:nogutter:nocontrols">

&lt;%= observe_form('search_form', 
    :url =&gt; {:action =&gt; 'search_count'},
    :frequency =&gt; 3,
    :condition =&gt; (@model_name == 'Contact' ? 
        "!$('search_form').submitting &#38;&#38; !contact_search_form_empty()" :
        "!$('search_form').submitting &#38;&#38; !outlet_search_form_empty()"),
    :with =&gt; "search_form",
    :loading =&gt; "$('spinner').show();",
    :complete =&gt; "$('spinner').hide();") %&gt;
</pre></div>

</div>
<div class="slide">

	<h1>Observing Fields</h1>


<div class="code-normal">

<pre name="code" class="ruby:nogutter:nocontrols">

&lt;%= observe_field("show_hide_select", 
    :url =&gt; { :action =&gt; 'toggle_column', :item_count =&gt; item_count },
    :with =&gt; "'column_name=' + value") %&gt;
</pre></div>

</div>
<div class="slide">

	<h1>Model Object <span class="caps">DOM</span> id</h1>


	<ul>
	<li>When we write <span class="caps">AJAX</span> applications we rely heavily on <span class="caps">DOM</span> ids for referencing different parts of a page.</li>
		<li>Rails provides the dom_id helper for this purpose: dom_id(Post.find(45)) # =&gt; &#8220;post_45&#8221;. You can also use &lt;% div_for(@person) do <span>&gt;...&lt;</span> end %&gt; to produce a div with the dom id of a model object.</li>
		<li>Alternatively you can use the Dashed <span class="caps">DOM ID</span> plugin which adds the dom_id method to your ActiveRecord models so you can say: Post.find(45).dom_id(&#8216;name&#8217;) # =&gt; &#8220;post-45-name&#8221;</li>
	</ul>


</div>
<div class="slide">

	<h1>The Spinner Icon</h1>


<div class="code-normal">

<pre name="code" class="ruby:nogutter:nocontrols">

# Spinning icon that is displayed when an AJAX request is in progress
&lt;img class="spinner" id="ajax_spinner" 
  src="/images/spinner.gif" alt="Comment being processed" style="display: none" /&gt;
</pre></div>

</div>
<div class="slide">

	<h1>Global <span class="caps">AJAX</span> Hooks for the Spinner Icon</h1>


<div class="code-normal">

<pre name="code" class="ruby:nogutter:nocontrols">

# In public/javascripts/application.js. Will show the spinner whenever
# an AJAX request is in process.
Ajax.Responders.register({ 
  onCreate: function(){ 
    $('spinner').show(); 
  }, 
  onComplete: function() { 
    if(Ajax.activeRequestCount == 0) 
      $('spinner').hide(); 
  } 
}); 
</pre></div>

</div>
<div class="slide">

	<h1>Drag and Drop Example: The Request Side</h1>


<div class="code-normal">

<pre name="code" class="ruby:nogutter:nocontrols">

# This example is about dragging books in list to a shopping cart in the menu bar.
&lt;li class="book" id="book_&lt;%= book.id %&gt;"&gt;
  ...book info here...
&lt;/li&gt;
&lt;%= draggable_element("book_#{book.id}", :revert =&gt; true) %&gt;
&lt;div id="shopping_cart"&gt;
  &lt;%= render :partial =&gt; "cart/cart" %&gt;
&lt;/div&gt;
&lt;%= drop_receiving_element("shopping_cart", :url =&gt; { :controller =&gt; "cart", :action =&gt; "add" }) %&gt;
</pre></div>

</div>
<div class="slide">

	<h1>Drag and Drop Example: Controller Action</h1>


<div class="code-normal">

<pre name="code" class="ruby:nogutter:nocontrols">

def add
    params[:id].gsub!(/book_/, "")
    @book = Book.find(params[:id])
    @item = @cart.add(params[:id])
    if request.xhr?
      flash.now[:cart_notice] = "Added &lt;em&gt;#{@item.book.title}&lt;/em&gt;" 
      render :action =&gt; "add_with_ajax" 
    elsif request.post?
      flash[:cart_notice] = "Added &lt;em&gt;#{@item.book.title}&lt;/em&gt;" 
      redirect_to :controller =&gt; "catalog" 
    end
end
</pre></div>

</div>
<div class="slide">

	<h1>Drag and Drop Example: <span class="caps">RJS</span> Template</h1>


<div class="code-normal">

<pre name="code" class="ruby:nogutter:nocontrols">

# add_with_ajax.js.rjs:
page.replace_html "shopping_cart", :partial =&gt; "cart" 
page.visual_effect :highlight, "cart_item_#{@item.book.id}", :duration =&gt; 3
page.visual_effect :fade, 'cart_notice', :duration =&gt; 3
</pre></div>

</div>
<div class="slide">

	<h1>Auto Completion</h1>


<div class="code-normal">

<pre name="code" class="ruby:nogutter:nocontrols">

# Installation
script/plugin install git://github.com/rails/auto_complete.git

# Controller
class BlogController &lt; ApplicationController
  auto_complete_for :post, :title
end

# View
&lt;%= text_field_with_auto_complete :post, title %&gt;
</pre></div>

</div>
<div class="slide">

	<h1>In-Place-Edit</h1>


<div class="code-normal">

<pre name="code" class="ruby:nogutter:nocontrols">

# Installation
script/plugin install git://github.com/rails/in_place_editing.git

# Controller. Warning: does not do validation.
class BlogController &lt; ApplicationController
  in_place_edit_for :post, :title
end

# View
&lt;%= in_place_editor_field :post, 'title' %&gt;
</pre></div>

</div>
<div class="slide">

	<h1>Degradability for When there is No JavaScript</h1>


	<ul>
	<li>form_remote_tag will by default fall and submit to the <span class="caps">AJAX URL</span>. To submit to a different <span class="caps">URL</span>, you can specify :html =&gt; {:action =&gt; {:action =&gt; &#8216;some_action&#8217;}}</li>
		<li>You can get link_to_remote to make a normal <span class="caps">GET</span> request if there is no JavaScript with the :href <span class="caps">HTML</span> option.</li>
		<li>In your actions you can give different responses depending on if the request is an <span class="caps">AJAX</span> request or not (using request.xhr?).</li>
	</ul>


</div>
<div class="slide">

	<h1><span class="caps">RJS</span> Reuse</h1>


<div class="code-normal">

<pre name="code" class="ruby:nogutter:nocontrols">

module ApplicationHelper
  def replace_article(article)
    update_page do |page|
      page[:article].replace partial =&gt; :article, :locals =&gt; {:article =&gt; article}
    end 
  end
end 

# In the controller action
render :update do |page|
  page &lt;&lt; replace_article(@article)
  page.highlight :article
end
</pre></div>

</div>
<div class="slide">

	<h1>Browser Tools</h1>


	<p>Firebug and the Web Developer Extension for Firefox are great tools when working with <span class="caps">AJAX</span>. You can use Firebug Lite in other browsers (i.e. IE on windows).</div></p>

  <!-- Syntax Highlighter -->
  <script language="javascript" src="../dp.SyntaxHighlighter/Scripts/shCore.js"></script>
  <script language="javascript" src="../dp.SyntaxHighlighter/Scripts/shBrushCpp.js"></script>
  <script language="javascript" src="../dp.SyntaxHighlighter/Scripts/shBrushRuby.js"></script>
  <script language="javascript" src="../dp.SyntaxHighlighter/Scripts/shBrushXml.js"></script>
  <script language="javascript">
  dp.SyntaxHighlighter.ClipboardSwf = '/flash/clipboard.swf';
  dp.SyntaxHighlighter.HighlightAll('code');
  </script>
</div>
</body>
</html>
